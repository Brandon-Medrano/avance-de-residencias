<!DOCTYPE html>
<html lang="en">
<head>
	<style>
	.axis {
	  font: 10px sans-serif;
	}
	.axis path,
	.axis line {
	  fill: none;
	  stroke:blue;
	  shape-rendering: crispEdges;
	}
	</style>
           <!-- ================= inicio head =============== -->
<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../css/main.css">
           <!-- =================Materilize=============== -->
          <link rel="stylesheet" href="css/materialize.min.css">
           <!-- ================= fin =============== -->
</head>
           <!-- ================= fin head =============== -->
           <!-- ================= empieza mi body =============== -->
<body>
<!--========================================contiene  graficas de la bd barras y la de mapa=================================================== -->
<div class='container' style='font: 12px sans-serif;'>
  <!-- 1 abierto-->
    <div class="card-panel white z-depth-4">     
                                          <div class="card-panel blue z-depth-4">
                                             <h3 align="center">Indicadores de la Propiedad Social en México (2010-2015)</h3>                    
                                         </div>                      
                 <div class="row">
                          <div class="col s12">
                                            <!-- ================= titulo =============== -->
                                           <!-- ================= fin titulo =============== -->
                                               <p align="center"> Avance de certificación</p>                       
                                            <div  id="us-chart" class="card-panel white z-depth-4">     
                                           </div>
                        </div> 
                 </div>                                                   
<!--========================================contiene  graficas interactivas dc=================================================== -->
        <div class="row">
            <div class="dc-data-count" style="float: left;">
                             <p>Registro Agrario Nacional
                                <span>
                                       <span class="filter-count"></span>
                                           selected out of 
                                        <span class="total-count"></span>
                                        records | 
                                         <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
                                </span>
                             </p>
             </div>
        </div>
<!--========================================bloque 1 div contenedor 1A=================================================== -->
  <div class='row'><!--primer row -->
              <div class='span6' id='dc-magnitude-chart'>
                          <h4>        
                              Numero de evento por Magnitud
                                 <span>
                                       <a class="reset"
                                             href="javascript:magnitudeChart.filterAll();dc.redrawAll();"
                                             style="display: none;">
                                             reset
                                       </a>
                                 </span>
	                        </h4>
               </div>
<!--========================================bloque 2 div row 1A=================================================== -->
        <div class='span6' id='dc-depth-chart'>
	              <h4>
	                   	Eventos por profundida(km)
                       <span>
                             <a class="reset"
                                    href="javascript:depthChart.filterAll();dc.redrawAll();"
                                    style="display: none;">
                                    reset
                             </a>
                       </span>
               </h4>
         </div>   
  </div><!--cierre del primer row -->
<!--========================================bloque 3 div row 1 cerrado =================================================== -->
  <div class='row'><!-- segundo row -->
                <div class='span12' id='dc-time-chart'>
                        <h4>
	                        	 Eventos por hora
                                <span>
                                       <a class="reset"
                                             href="javascript:timeChart.filterAll();dc.redrawAll();"
                                             style="display: none;">
                                             reset
                                       </a>
                                </span>
	                     </h4>
                </div>
  </div>
  <!--- ====================  bloque 3 ===============================================-->
  <div class='row'> <!-- aqui row fata cerrar-->
                        <div class='span4' id='dc-dayweek-chart'>
                                      <h4>
                                                    Dia de la semana
                                               <span>
                                                        <a class="reset"
                                                                href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();"
                                                               style="display: none;">
                                                           reset
                                                        </a>
                                               </span>
                                       </h4>
                             
  <!--- ====================  ===============================================-->
                                       <!--abre y cierra -->                       <div class="clearfix"></div>
                           </div>
  <!--- ==================== falta cerrar el row  dice aqui row falta cerrar===============================================--> 
                                      <div class='span4' id='dc-island-chart'>
	                                                          <h4>
		                                                                   Isla norte o Sur
                                                                            <span>
                                                                                     <a class="reset"
                                                                                             href="javascript:islandChart.filterAll();dc.redrawAll();"
                                                                                             style="display: none;">
                                                                                             reset
                                                                                       </a>
                                                                            </span>
                                                              </h4>
                                        </div>
  <!---========================================================================================================== -->                                     
                    <div class='span4' id='blank2'>
	                                                  <h4>Blank 2</h4>
                    </div> 
  </div><!--cierre del row  que dice aqui falta cerrar-->
  <!--- ====================  bloque 3 ===============================================-->
            <div class='row'>
                      	<div class='span12'>
                                   <table class='table table-hover' id='dc-table-graph'>
                                             <thead>
                                                      <tr class='header'>
                                                              <th>DTG</th>
                                                              <th>Lat</th>
                                                              <th>Largo</th>
                                                              <th>Profundidad</th>
                                                              <th>Magnitud</th>
                                                              <th>Google Map</th>
                                                              <th>OSM Map</th>
                                                       </tr>
                                               </thead>
                                    </table>
	                      </div>
          </div>
<!--========================================fin de graficas interactivas=================================================== -->
<!--========================================contiene  graficas interactivas del mapa=================================================== -->
                                                          <!-- ================= identificador  industry chart =============== -->
                                                                             <div id="industry-chart"  class="card-panel white z-depth-4">
                                                                                    <strong>Documentos expedidos</strong> (y: Numero de documentos, x: Total en miles)
                                                                                     <a class="reset" href="javascript:industryChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>            
                                                                              </div>
                                                               <!-- ================= identificador de round chart =============== -->
                                                                                        <div id="round-chart"  class="card-panel white z-depth-4">
                                                                                                <strong>By Rounds</strong> (y: number of deals, x: total amount raised in millions, radius: amount raised)
                                                                                                <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                                                                                        </div>  
  
<!--========================================================================================-->
  <!--cierre contenedor principal -->
    </div>
</div>
<!--========================================================================================-->
<!--========================================================================================-->

<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<!--=======================================lo de graficas ===========================================-->
  <link href='dc.css' rel='stylesheet' type='text/css'>
  <script src='crossfilter.js' type='text/javascript'></script>
  <script src='dc.js' type='text/javascript'></script>
  <script src='jquery-1.9.1.min.js' type='text/javascript'></script>
  <script src='bootstrap.min.js' type='text/javascript'></script>
  <link href='bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='dc.css' rel='stylesheet' type='text/css'>
<!--========================================================================================-->

<!--=================================script de barras=======================================================-->
<!--=================================fin script de grafica de barra=======================================================-->
<!--=================================script de mapa y dos graficas=======================================================-->
<script type="text/javascript"> 
    var numberFormat = d3.format(".2f");
    var usChart = dc.geoChoroplethChart("#us-chart");
    var industryChart = dc.bubbleChart("#industry-chart");
    var roundChart = dc.bubbleChart("#round-chart");
    d3.csv("vc.csv", function (csv) {
        var data = crossfilter(csv);
        var states = data.dimension(function (d) {
          return d["State"]; //retonar la dimecion del estado en  la etiqueta
        });
        var stateRaisedSum = states.group().reduceSum(function (d) {
        return d["Raised"]; //valores d ela etiquetas
        });

        var industries = data.dimension(function (d) {
         return d["Industry Group"];
        });
        var statsByIndustries = industries.group().reduce(
                function (p, v) {
                    p.amountRaised += +v["Raised"];
                    p.deals += +v["Deals"];
                    return p;
                },
                function (p, v) {
                    p.amountRaised -= +v["Raised"];
                    if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                    p.deals -= +v["Deals"];
                    return p;
                },
                function () {
                    return {amountRaised: 0, deals: 0}
                }
        );

        var rounds = data.dimension(function (d) {
            return d["RoundClassDescr"];
        });
        var statsByRounds = rounds.group().reduce(
                function (p, v) {
                    p.amountRaised += +v["Raised"];
                    p.deals += +v["Deals"];
                    return p;
                },
                function (p, v) {
                    p.amountRaised -= +v["Raised"];
                    if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                    p.deals -= +v["Deals"];
                    return p;
                },
                function () {
                    return {amountRaised: 0, deals: 0}
                }
        );

        d3.json("../geo/us-states.json", function (statesJson) {
            usChart.width(990)
                    .height(380)
                    .dimension(states)
                    .group(stateRaisedSum)
                    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 200])
                    .colorCalculator(function (d) { return d ? usChart.colors()(d) : '#ccc'; })
                    .overlayGeoJson(statesJson.features, "Estado", function (d) {
                        return d.properties.name;
                    })
                    .title(function (d) {
                        return "State: " + d.key + "\nTotal Amount Raised: " + numberFormat(d.value ? d.value : 0) + "M";
                    });


            industryChart.width(990)
                    .height(200)
                    .margins({top: 10, right: 50, bottom: 30, left: 60})
                    .dimension(industries)
                    .group(statsByIndustries)
                    .colors(d3.scale.category10())
                    .keyAccessor(function (p) {
                        return  p.value.amountRaised;
                    })
                    .valueAccessor(function (p) {
                        return p.value.deals;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .x(d3.scale.linear().domain([0, 5000]))
                    .r(d3.scale.linear().domain([0, 4000]))
                    .minRadiusWithLabel(15)
                    .elasticY(true)
                    .yAxisPadding(100)
                    .elasticX(true)
                    .xAxisPadding(200)
                    .maxBubbleRelativeSize(0.07)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .title(function (p) {
                        return p.key
                                + "\n"
                                + "Amount Raised: " + numberFormat(p.value.amountRaised) + "M\n"
                                + "Number of Deals: " + numberFormat(p.value.deals);
                    });
   
            industryChart.yAxis().tickFormat(function (s) {
                return s + " deals";
            });
           industryChart.xAxis().tickFormat(function (s) {
                return s + "M";
            });
            roundChart.width(990)
                    .height(200)
                    .margins({top: 10, right: 50, bottom: 30, left: 60})
                    .dimension(rounds)
                    .group(statsByRounds)
                    .colors(d3.scale.category10())
                    .keyAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .valueAccessor(function (p) {
                        return p.value.deals;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .x(d3.scale.linear().domain([0, 5000]))
                    .r(d3.scale.linear().domain([0, 9000]))
                    .minRadiusWithLabel(15)
                    .elasticY(true)
                    .yAxisPadding(150)
                    .elasticX(true)
                    .xAxisPadding(300)
                    .maxBubbleRelativeSize(0.07)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .title(function (p) {
                        return p.key
                                + "\n"
                                + "Amount Raised: " + numberFormat(p.value.amountRaised) + "M\n"
                                + "Number of Deals: " + numberFormat(p.value.deals);
                    });
            roundChart.yAxis().tickFormat(function (s) {
                return s + " deals";
            });
            roundChart.xAxis().tickFormat(function (s) {
                return s + "M";
            });

            dc.renderAll();
        });
    });
    // Create the dc.js chart objects & link to div
var dataTable = dc.dataTable("#dc-table-graph");
var magnitudeChart = dc.barChart("#dc-magnitude-chart");
var depthChart = dc.barChart("#dc-depth-chart");
var dayOfWeekChart = dc.rowChart("#dc-dayweek-chart");
var islandChart = dc.pieChart("#dc-island-chart");
var timeChart = dc.lineChart("#dc-time-chart");
// load data from a csv file
d3.json("php/data3.php", function (data) {
  // fparseio de formato de nuestro acrhivos
  var dtgFormat = d3.time.format("%Y-%m-%dT%H:%M:%S");
  var dtgFormat2 = d3.time.format("%a %e %b %H:%M");
  data.forEach(function(d) { 
    d.dtg1  = d.origintime.substr(0,10) + " " + d.origintime.substr(11,8);
    d.dtg   = dtgFormat.parse(d.origintime.substr(0,19)); 
    d.lat   = +d.latitude;
    d.long  = +d.longitude;
    d.mag   = d3.round(+d.magnitude,1);
    d.depth = d3.round(+d.depth,0);
    
  
  });
  // Ejecutar los datos a través de crossfilter y cargar nuestros "hechos"
  var facts = crossfilter(data);
  var all = facts.groupAll();

  // for Magnitude
  var magValue = facts.dimension(function (d) {
    return d.mag;       // add the magnitude dimension
  });
  var magValueGroupSum = magValue.group()
    .reduceSum(function(d) { return d.mag; });	// sums 
  var magValueGroupCount = magValue.group()
    .reduceCount(function(d) { return d.mag; }) // counts 
  // for Depth
  var depthValue = facts.dimension(function (d) {
    return d.depth;
  });
  var depthValueGroup = depthValue.group();

  // time chart
  var volumeByHour = facts.dimension(function(d) {
    return d3.time.hour(d.dtg);
  });
  var volumeByHourGroup = volumeByHour.group()
    .reduceCount(function(d) { return d.dtg; });

  // row chart Day of Week
  var dayOfWeek = facts.dimension(function (d) {
    var day = d.dtg.getDay();
    switch (day) {
      case 0:
        return "0.Sun";
      case 1:
        return "1.Mon";
      case 2:
        return "2.Tue";
      case 3:
        return "3.Wed";
      case 4:
        return "4.Thu";
      case 5:
        return "5.Fri";
      case 6:
        return "6.Sat";
    }
  });
  var dayOfWeekGroup = dayOfWeek.group();

  // Pie Chart
  var islands = facts.dimension(function (d) {

    if (d.lat <= -40.555907 && d.long <= 174.590607)
      return "Df";
    else
    return "Sonora";
    });

  var islandsGroup = islands.group();


  // Create datatable dimension
  var timeDimension = facts.dimension(function (d) {
    return d.dtg;
  });
  // Setup the charts
  // count all the facts
  dc.dataCount(".dc-data-count")
    .dimension(facts)
    .group(all);
    
  // Magnitide Bar Graph Counted
  magnitudeChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(magValue)
    .group(magValueGroupCount)
	.transitionDuration(500)
    .centerBar(true)	
	.gap(65)  // 65 = norm
//    .filter([3, 5])
    .x(d3.scale.linear().domain([0.5, 7.5]))
	.elasticY(true)
	.xAxis().tickFormat();	

  // Depth bar graph
  depthChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(depthValue)
    .group(depthValueGroup)
	.transitionDuration(500)
    .centerBar(true)	
	.gap(1)  
    .x(d3.scale.linear().domain([0, 100]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});

  // time graph
  timeChart.width(960)
    .height(150)
    .transitionDuration(500)
//    .mouseZoomable(true)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(volumeByHour)
    .group(volumeByHourGroup)
//    .brushOn(false)			// added for title
    .title(function(d){
      return dtgFormat2(d.data.key)
      + "\nNumber of Events: " + d.data.value;
      })
	.elasticY(true)
    .x(d3.time.scale().domain(d3.extent(data, function(d) { return d.dtg; })))
    .xAxis();

  // row chart day of week
  dayOfWeekChart.width(300)
    .height(220)
    .margins({top: 5, left: 10, right: 10, bottom: 20})
    .dimension(dayOfWeek)
    .group(dayOfWeekGroup)
    .colors(d3.scale.category10())
    .label(function (d){
       return d.key.split(".")[1];
    })
    .title(function(d){return d.value;})
    .elasticX(true)
    .xAxis().ticks(4);

  // islands pie chart
  islandChart.width(250)
    .height(220)
    .radius(100)
    .innerRadius(30)
    .dimension(islands)
    .title(function(d){return d.value;})
    .group(islandsGroup);
  // Table of earthquake data
  dataTable.width(960).height(800)
    .dimension(timeDimension)
	.group(function(d) { return "Earthquake Table"
	 })
	.size(10)
    .columns([
      function(d) { return d.dtg1; },
      function(d) { return d.lat; },
      function(d) { return d.long; },
      function(d) { return d.depth; },
      function(d) { return d.mag; },
	  function(d) { return '<a href=\"http://maps.google.com/maps?z=12&t=m&q=loc:' + d.lat + '+' + d.long +"\" target=\"_blank\">Google Map</a>"},
	  function(d) { return '<a href=\"http://www.openstreetmap.org/?mlat=' + d.lat + '&mlon=' + d.long +'&zoom=12'+ "\" target=\"_blank\"> OSM Map</a>"}
    ])
    .sortBy(function(d){ return d.dtg; })
    .order(d3.ascending);
  // Render the Charts
  dc.renderAll();
});
</script>
<!--=================================cierre de graficas interactivas=======================================================-->
</body>
</html>
